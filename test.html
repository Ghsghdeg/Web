<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Тести - Автошкола</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">Авто<span>Школа</span></div>
            <nav>
                <ul>
                    <li><a href="Main.html">Головна</a></li>
                    <li><a href="pdr.html"class="active">ПДР</a></li> 
                    <li><a href="test.html"class="active">Тести</a></li>
                    <li><a href="#">Відгуки</a></li>
                    <li><a href="Contact.html" >Контакти</a></li>
                    
                </ul>
            </nav>
        </div>
    </header>
    <div class="container">
        <h1>Виберіть тип тестування</h1>

        <div class="tab-buttons">
            <button id="btn-topics" class="active">Тести по темах</button>
            <button id="btn-random">Випадкове тестування</button>
        </div>

        <div id="topics-section" class="content-section">
            <label>Оберіть тему:</label>
            <ul class="topic-list" id="topic-list">
                <!-- Теми підвантажуються сюди -->
            </ul>
            <button class="start-test" id="start-topic-test" disabled>Почати тест</button>
        </div>

        <div id="random-section" class="content-section" style="display:none;">
            <label>Оберіть кількість питань:</label>
            <input type="number" id="random-question-count" min="1" max="50" value="10" />
            <button class="start-test" id="start-random-test">Почати тест</button>
        </div>

        <div id="message-box" class="message" style="display:none;"></div>
    </div>

    <script>
        const API_BASE = "https://pdd-api.duckdns.org/api/tests";
    
        document.getElementById('btn-topics').addEventListener('click', () => {
            document.getElementById('topics-section').style.display = 'block';
            document.getElementById('random-section').style.display = 'none';
            document.getElementById('btn-topics').classList.add('active');
            document.getElementById('btn-random').classList.remove('active');
        });
    
        document.getElementById('btn-random').addEventListener('click', () => {
            document.getElementById('topics-section').style.display = 'none';
            document.getElementById('random-section').style.display = 'block';
            document.getElementById('btn-random').classList.add('active');
            document.getElementById('btn-topics').classList.remove('active');
        });
    
        // ==== 2. Отримати список тем ====
        async function loadTopics() {
            try {
                const response = await fetch(`${API_BASE}/topics`);
                
                if (!response.ok) {
                    throw new Error('Помилка завантаження тем');
                }
                
                const topics = await response.json();
                
                if (!Array.isArray(topics) || topics.length === 0) {
                    throw new Error('Немає доступних тем');
                }
                
                const list = document.getElementById('topic-list');
                list.innerHTML = '';
    
                topics.forEach(topic => {
                    const topicId = topic.testID || topic.TestID;
                    const title = topic.title || topic.Title;
                    
                    if (!topicId) return;
                    
                    const li = document.createElement('li');
                    li.textContent = title || `Тема ${topicId}`;
                    li.dataset.id = topicId;
                    li.addEventListener('click', () => {
                        [...list.children].forEach(c => c.classList.remove('selected'));
                        li.classList.add('selected');
                        document.getElementById('start-topic-test').disabled = false;
                    });
                    list.appendChild(li);
                });
            } catch (err) {
                alert('Помилка завантаження тем. Перевірте підключення до сервера.');
                const list = document.getElementById('topic-list');
                list.innerHTML = '<li style="color: red;">Помилка завантаження тем</li>';
            }
        }
    
        // ==== 3. Почати тест по темі ====
        async function startTestByTopic() {
            const selected = document.querySelector('#topic-list li.selected');
            if (!selected) {
                alert('Будь ласка, оберіть тему для тестування');
                return;
            }
    
            const testId = selected.dataset.id;
            if (!testId) {
                alert('Помилка: не знайдено ID теми');
                return;
            }
                
            try {
                const response = await fetch(`${API_BASE}/by-test/${testId}`);
                
                if (!response.ok) {
                    throw new Error(`Помилка сервера: ${response.status}`);
                }
                
                const questions = await response.json();
                
                if (!questions || !Array.isArray(questions) || questions.length === 0) {
                    throw new Error('Не отримано питань від сервера');
                }
                
                launchTest(questions);
            } catch (error) {
                alert(`Помилка при завантаженні тесту: ${error.message}`);
            }
        }
    
        // ==== 4. Випадковий тест ====
        async function startRandomTest() {
            try {
                const count = document.getElementById('random-question-count').value;
                const response = await fetch(`${API_BASE}/random/${count}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const questions = await response.json();
                if (!questions || !Array.isArray(questions) || questions.length === 0) {
                    throw new Error('No questions received from the server');
                }
                launchTest(questions);
            } catch (error) {
                console.error('Error starting random test:', error);
                alert('Помилка при завантаженні тесту. Спробуйте ще раз.');
            }
        }
    
        // ==== 5. Відобразити тест ====
        function launchTest(questions) {
            // Перейти на окрему сторінку з передачею JSON через sessionStorage
            console.log("questions from API:", questions);

            sessionStorage.setItem('testQuestions', JSON.stringify(questions));
            window.location.href = 'test-run.html';
        }
    
        document.getElementById('start-topic-test').addEventListener('click', startTestByTopic);
        document.getElementById('start-random-test').addEventListener('click', startRandomTest);
    
        // Початкове завантаження тем
        loadTopics();
    </script>
    

</body>
</html>
